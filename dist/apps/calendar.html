<!DOCTYPE html>
<html lang="es">

<head>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Meta -->
  <meta name="description" content="Fut 7 - Montessori">
  <meta name="author" content="Fut 7 - Montessori">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="../assets/img/favicon.ico">

  <title>Fut 7 - Montessori</title>

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="../lib/remixicon/fonts/remixicon.css">
  <link rel="stylesheet" href="../lib/fullcalendar/main.min.css">

  <!-- Template CSS -->
  <link rel="stylesheet" href="../assets/css/style.min.css">

  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"> -->
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="app-calendar sidebar-offset">

  <div class="sidebar">
    <div class="sidebar-header">
      <a href="#" class="sidebar-logo">FUT7</a>
    </div><!-- sidebar-header -->
    <div id="sidebarMenu" class="sidebar-body">
      <div class="nav-group"> </div><!-- nav-group -->
      <div class="nav-group show">
        <ul class="nav nav-sidebar">
          <li class="nav-item">
            <a href="#" class="nav-link active"><i class="ri-calendar-fill"></i> <span>Calendario Rentas</span></a>
          </li>
          <!-- <li class="nav-item">
            <a href="../apps/email.html" class="nav-link"><i class="ri-question-answer-line"></i> <span>Chat</span></a>
          </li> -->
          <li class="nav-item"></li>
          <a href="../pages/faq.html" class="nav-link"><i class="ri-file-text-line"></i> <span>Reglamento</span></a>
          </li>
          <li class="nav-item"></li>
          <a href="../pages/privacypolicies.html" class="nav-link"><i class="ri-file-text-line"></i> <span>Políticas de
              Privacidad</span></a>
          </li>
        </ul>
      </div><!-- nav-group -->
      <div class="nav-group">

      </div><!-- nav-group -->
      <div class="nav-group mb-3">

      </div><!-- nav-group -->
    </div><!-- sidebar-body -->
    <div class="sidebar-footer">
      <div class="sidebar-footer-top">
        <div class="sidebar-footer-thumb">
          <img src="../assets/img/img1.jpg" alt="">
        </div><!-- sidebar-footer-thumb -->
        <div class="sidebar-footer-body">
          <h6 class="usuarioBarra"><a href="../pages/profile.html">Usuario</a></h6>
        </div><!-- sidebar-footer-body -->
        <a id="sidebarFooterMenu" href="" class="dropdown-link"><i class="ri-arrow-down-s-line"></i></a>
      </div><!-- sidebar-footer-top -->
      <div class="sidebar-footer-menu">
        <nav class="nav">
          <a href="../pages/profile.html"><i class="ri-edit-2-line"></i>Perfil</a>
        </nav>
        <hr>
        <nav class="nav">
          <a href="../pages/sign-in.html"><i class="ri-logout-box-r-line"></i> Cerrar Sesion</a>
        </nav>
      </div><!-- sidebar-footer-menu -->
    </div><!-- sidebar-footer -->
  </div><!-- sidebar -->

  <div class="header-main px-3 px-lg-4">
    <a id="menuSidebarOffset" href="#" class="menu-link me-3 me-lg-4"><i class="ri-menu-2-fill"></i></a>
    <div class="me-auto">

    </div><!-- form-search -->

    <div class="dropdown dropdown-skin">
      <a href="" class="dropdown-link" data-bs-toggle="dropdown" data-bs-auto-close="outside"><i
          class="ri-settings-3-line"></i></a>
      <div class="dropdown-menu dropdown-menu-end mt-10-f">
        <label>Modo</label>
        <nav id="skinMode" class="nav nav-skin">
          <a href="" class="nav-link active">Claro</a>
          <a href="" class="nav-link">Oscuro</a>
        </nav>
      </div><!-- dropdown-menu -->
    </div><!-- dropdown -->

    <div class="dropdown dropdown-profile ms-3 ms-xl-4">
      <a href="" class="dropdown-link" data-bs-toggle="dropdown" data-bs-auto-close="outside">
        <div class="avatar online"><img src="../assets/img/img1.jpg" alt=""></div>
      </a>
      <div class="dropdown-menu dropdown-menu-end mt-10-f">
        <div class="dropdown-menu-body">
          <div class="avatar avatar-xl online mb-3"><img src="../assets/img/img1.jpg" alt=""></div>
          <h5 id="usuarioBarra" class="mb-1 text-dark fw-semibold">Usuario</h5>

          <nav class="nav">
            <a href="../pages/profile.html"><i class="ri-edit-2-line"></i> Perfil</a>
            <a href="../pages/sign-in.html"><i class="ri-logout-box-r-line"></i> Cerrar Sesion</a>
          </nav>
        </div><!-- dropdown-menu-body -->
      </div><!-- dropdown-menu -->
    </div><!-- dropdown -->
  </div><!-- header-main -->

  <div class="main main-calendar">
    <div class="calendar-sidebar">
      <div id="calSidebar" class="sidebar-body">
        <div class="d-grid mb-3">
          <a id="btnCreateEvent" href="" class="btn btn-primary">Crear nueva reserva</a>
        </div>
        <div id="datepicker1" class="task-calendar mb-5"></div>

        <nav class="nav nav-calendar mb-4">
          <a href="" class="nav-link discover"><span></span> Confirmadas</a>
          <a href="" class="nav-link meetup"><span></span> Pendientes</a>
          <a href="" class="nav-link holiday"><span></span> Finalizadas</a>
        </nav>
      </div><!-- sidebar-body -->
    </div><!-- calendar-sidebar -->
    <div id="calendar" class="calendar-body"></div>
  </div><!-- main -->

  <div class="modal modal-event fade" id="modalCreateEvent" tabindex="-1" aria-labelledby="modalLabelCreateEvent"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="modalLabelCreateEvent">Nueva reserva</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div><!-- modal-header -->

        <div class="modal-body">

          <div class="g-3 mb-3 row">
            <div class="col-md-2 col-3">
              <label class="form-label">Asistentes:</label>
              <input id="asistentes" name="asistentes" type="number" class="form-control " placeholder="#" min="1">
            </div>
          </div>

          <div class="g-3 mb-3 row">
            <div class="col-md-5 col-7">
              <label class="form-label">Fecha:</label>
              <input id="fecha" name="fecha" type="date" class="form-control" placeholder="Escoge una fecha">
            </div><!-- col -->

            <div class="col">
              <label class="form-label">Inicio:</label>
              <select id="horaInicio" name="horaInicio" class="form-select">
                <option>Hora...</option>
              </select>
            </div><!-- col -->

            <div class="col">
              <label class="form-label">Finalización:</label>
              <select id="horaFin" name="horaFin" class="form-select">
                <option></option>
              </select>
            </div><!-- col -->

          </div><!-- row -->

          <div class="mb-3">
            <div class="col-md-3 col-3">
              <label class="form-label">Total:</label>
              <input id="total" name="total" type="text" class="form-control" placeholder="Automático" disabled>
            </div>
          </div>
        </div><!-- modal-body -->

        <div class="modal-footer">
          <button id="btnGuardar" type="button" class="btn btn-primary">Guardar</button>
        </div><!-- modal-footer -->

        <div id="stripe-container">
        </div><!-- stripe-container -->

      </div><!-- modal-content -->
    </div><!-- modal-dialog -->
  </div><!-- modal -->

  <div class="modal modal-event fade" id="modalCancelarEvent" tabindex="-1" aria-labelledby="modalLabelCancelarEvent"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="modalLabelCancelarEvent">Cancelar reserva</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div><!-- modal-header -->

        <div class="modal-body">

          <div class="g-3 mb-3 row">
            <div class="col-md-2 col-3">
              <label class="form-label">Nombre:</label>
              <input id="nombreCancelCliente" name="nombreCancelCliente" type="text" class="form-control " placeholder="Nombre" disabled>
            </div>
          </div>

          <div class="g-3 mb-3 row">
            <div class="col-md-2 col-3">
              <label class="form-label">Asistentes:</label>
              <input id="asistentesCancel" name="asistentesCancel" type="number" class="form-control " placeholder="#"
                min="1" max="14" disabled>
            </div>
          </div>

          <div class="g-3 mb-3 row">
            <div class="col-md-5 col-7">
              <label class="form-label">Fecha:</label>
              <input id="fechaCancel" name="fechaCancel" type="date" class="form-control"
                placeholder="Esta es tu fecha de reserva" disabled>
            </div><!-- col -->

            <div class="col">
              <label class="form-label">Inicio:</label>
              <input id="horaInicioCancel" name="horaInicioCancel" type="text" class="form-control"
                placeholder="Esta es tu hora inicio de reserva" disabled>
            </div><!-- col -->

            <div class="col">
              <label class="form-label">Finalización:</label>
              <input id="HoraFinCancel" name="HoraFinCancel" type="text" class="form-control"
                placeholder="Esta es tu hora fin de reserva" disabled>
            </div><!-- col -->

          </div><!-- row -->
        </div><!-- modal-body -->

        <div class="modal-footer">
          <button id="btnCancelar" type="button" class="btn btn-danger">Cancelar</button>
        </div><!-- modal-footer -->


      </div><!-- modal-content -->
    </div><!-- modal-dialog -->
  </div><!-- modal -->

  <script src="../lib/jquery/jquery.min.js"></script>
  <script src="../lib/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../lib/perfect-scrollbar/perfect-scrollbar.min.js"></script>
  <script src="../lib/jqueryui/jquery-ui.min.js"></script>
  <script src="../lib/moment/moment.min.js"></script>
  <script src="../lib/fullcalendar/main.min.js"></script>

  <script src="../assets/js/script.js"></script>
  <script src="../assets/js/calendar-events.js"></script>
  <script src="../assets/js/hours.js"></script>

  <script>
    'use script'


  </script>
  <script>
    // Stripe setup
    // const stripe = Stripe('pk_live_51PyhP5KJQTnSHL1ZgCd4aiOMCm8i7w6EKzBzf2XsYUvAoSiUdHGbGrJT9myaYySsj2hNtSvNGyZZsJMGp941azbt003Rs2iw1X');
    let elements;
    let clientSecret = "";
    const stripe = Stripe('pk_live_51PyhP5KJQTnSHL1ZgCd4aiOMCm8i7w6EKzBzf2XsYUvAoSiUdHGbGrJT9myaYySsj2hNtSvNGyZZsJMGp941azbt003Rs2iw1X');

    document.addEventListener('DOMContentLoaded', function () {
      const btnGuardar = document.getElementById('btnGuardar');

      // Manejar el clic en el botón de guardar
      btnGuardar.addEventListener('click', async function () {
        const asistentes = document.getElementById('asistentes').value;
        const fecha = fechaInput.value;
        const inicio = horaInicioSelect.value;
        const finalizacion = horaFinSelect.value;
        const total = totalInput.value;

        if (!fecha || !inicio || !finalizacion) {
          alert('Por favor, complete todos los campos.');
          return;
        }

        const userCookie = getCookie('user');
        if (!userCookie) {
          alert('Error: No se encontró la cookie de usuario. Por favor, inicia sesión.');
          return;
        }

        let userData;
        try {
          // Decodificar el valor de la cookie antes de parsear
          const decodedCookie = decodeURIComponent(userCookie);
          console.log('Cookie decodificada:', decodedCookie); // Para verificar el valor decodificado
          userData = JSON.parse(decodedCookie);
        } catch (error) {
          alert('Error: La cookie de usuario no tiene un formato válido.');
          console.error('Error al parsear la cookie de usuario:', error);
          return;
        }

        if (!userData.token) {
          alert('Error: La cookie de usuario no contiene un token válido.');
          return;
        }

        const reserva = {
          token: userData.token,
          cliente: JSON.stringify(userData),
          numero_asistentes: asistentes,
          fecha: fecha,
          inicio: inicio,
          finalizacion: finalizacion,
          total: total,
        };

        try {
          const response = await fetch('https://fut7montessori.com.mx/dist/model/reserva.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(reserva)
          });

          const result = await response.json();
          if (result.status === "Horario no disponible") {
            alert('Horario no disponible');
            return;
          }

          clientSecret = result.status;
          console.log('Reserva creada con éxito:', result);
          mostrarFormularioStripe();
        } catch (error) {
          console.error('Error al guardar la reserva:', error);
        }
      });

      // Función para obtener la cookie por nombre
      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }
    });

    function mostrarFormularioStripe() {
      // Crea el contenedor de Stripe si no existe
      let stripeContainer = document.getElementById('stripe-container');
      if (!stripeContainer) {
        stripeContainer = document.createElement('div');
        stripeContainer.id = 'stripe-container';
        document.body.appendChild(stripeContainer); // Agrega el contenedor de Stripe al DOM
      }

      elements = stripe.elements({ clientSecret }); // Inicializa Elements con el clientSecret
      const paymentElement = elements.create('payment'); // Crea el elemento de pago de Stripe

      // Vaciar el contenedor y montar el elemento de pago
      stripeContainer.innerHTML = '';
      const paymentForm = document.createElement('form');
      paymentForm.id = 'payment-form';
      paymentForm.addEventListener('submit', handleSubmit);

      // Contenedor del elemento de pago
      const paymentDiv = document.createElement('div');
      paymentDiv.id = 'payment-element';
      stripeContainer.appendChild(paymentDiv);
      paymentElement.mount('#payment-element'); // Monta el elemento de pago

      const submitButton = document.createElement('button');
      submitButton.id = 'submit';
      submitButton.type = 'submit';
      submitButton.innerHTML = `Pay now`;
      paymentForm.appendChild(submitButton);

      const messageDiv = document.createElement('div');
      messageDiv.id = 'payment-message';
      paymentForm.appendChild(messageDiv);

      stripeContainer.appendChild(paymentForm);
    }



    // Manejar el envío del formulario de Stripe
    async function handleSubmit(e) {
      e.preventDefault();

      if (!stripe || !elements) {
        return; // Stripe.js aún no ha cargado.
      }

      setLoading(true);

      try {
        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: "https://fut7montessori.com.mx/apps/calendar", // Cambia esto a tu página de confirmación de pago
          },
          redirect: 'if_required'
        });

        if (error) {
          setMessage(error.message);
        } else {
          setMessage("Gracias por tu pago, te hemos enviado un correo con los datos de la reservación.");
          alert('Pago completado y reserva confirmada.');
          retrievePaymentIntent(); // Mostrar la página de estado de pago
        }
      } catch (error) {
        setMessage("An unexpected error occurred.");
      }

      setLoading(false);
    }

    // Función para establecer el mensaje
    function setMessage(msg) {
      const messageElement = document.getElementById('payment-message');
      if (messageElement) {
        messageElement.textContent = msg;
      }
    }

    // Función para manejar el estado de carga
    function setLoading(state) {
      const submitButton = document.getElementById('submit');
      if (submitButton) {
        submitButton.disabled = state || !stripe || !elements;
      }
    }

    // Función para calcular el total basado en la duración de la reserva
    function calcularTotal(horaInicio, horaFin) {
      const [startHour, startMinutes] = horaInicio.split(':').map(Number);
      const [endHour, endMinutes] = horaFin.split(':').map(Number);

      const startTimeInMinutes = startHour * 60 + startMinutes;
      const endTimeInMinutes = endHour * 60 + endMinutes;
      const durationInHours = (endTimeInMinutes - startTimeInMinutes) / 60;

      // Calcular el costo basado en la duración en horas
      if (durationInHours === 1) {
        return 500;
      } else if (durationInHours === 1.5) {
        return 650;
      } else if (durationInHours === 2) {
        return 800;
      } else {
        return 0;
      }
    }

    // Función para obtener el estado del PaymentIntent
    async function retrievePaymentIntent() {
      const clientSecret = new URLSearchParams(window.location.search).get("payment_intent_client_secret");

      if (!clientSecret) return;

      try {
        const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);
        if (!paymentIntent) return;

        status = paymentIntent.status;
        intentId = paymentIntent.id;
        createPaymentStatusPage(); // Crear la página de estado del pago
      } catch (error) {
        console.error("Error retrieving payment intent:", error);
        status = "default";
        createPaymentStatusPage();
      }
    }

    // Función para crear el contenido de la página según el estado del pago
    function createPaymentStatusPage() {
      const paymentStatusDiv = document.createElement('div');
      paymentStatusDiv.id = 'payment-status';

      const statusIconDiv = document.createElement('div');
      statusIconDiv.id = 'status-icon';
      statusIconDiv.style.backgroundColor = STATUS_CONTENT_MAP[status].iconColor;
      statusIconDiv.appendChild(STATUS_CONTENT_MAP[status].icon);

      const statusText = document.createElement('h2');
      statusText.id = 'status-text';
      statusText.textContent = STATUS_CONTENT_MAP[status].text;

      paymentStatusDiv.appendChild(statusIconDiv);
      paymentStatusDiv.appendChild(statusText);

      if (intentId) {
        const detailsTable = document.createElement('div');
        detailsTable.id = 'details-table';
        detailsTable.innerHTML = `
          <table>
            <tbody>
              <tr>
                <td class="TableLabel">id</td>
                <td id="intent-id" class="TableContent">${intentId}</td>
              </tr>
              <tr>
                <td class="TableLabel">status</td>
                <td id="intent-status" class="TableContent">${status}</td>
              </tr>
            </tbody>
          </table>
        `;
        paymentStatusDiv.appendChild(detailsTable);

        const viewDetailsLink = document.createElement('a');
        viewDetailsLink.href = `https://dashboard.stripe.com/payments/${intentId}`;
        viewDetailsLink.id = 'view-details';
        viewDetailsLink.target = '_blank';
        viewDetailsLink.rel = 'noopener noreferrer';
        viewDetailsLink.innerHTML = `View details`;
        paymentStatusDiv.appendChild(viewDetailsLink);
      }

      const retryButton = document.createElement('a');
      retryButton.id = 'retry-button';
      retryButton.href = "/checkout";
      retryButton.textContent = "Test another";
      paymentStatusDiv.appendChild(retryButton);

      document.body.appendChild(paymentStatusDiv);
    }

    // Mapa de estado y contenido del estado del pago
    const STATUS_CONTENT_MAP = {
      succeeded: {
        text: "Payment succeeded",
        iconColor: "#30B130",
        icon: createSuccessIcon(),
      },
      processing: {
        text: "Your payment is processing.",
        iconColor: "#6D6E78",
        icon: createInfoIcon(),
      },
      requires_payment_method: {
        text: "Your payment was not successful, please try again.",
        iconColor: "#DF1B41",
        icon: createErrorIcon(),
      },
      default: {
        text: "Something went wrong, please try again.",
        iconColor: "#DF1B41",
        icon: createErrorIcon(),
      }
    };

    // Funciones para crear íconos SVG
    function createSuccessIcon() {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "16");
      svg.setAttribute("height", "14");
      svg.setAttribute("viewBox", "0 0 16 14");
      svg.innerHTML = `<path fill-rule="evenodd" clip-rule="evenodd" d="M15.4695 0.232963C15.8241 0.561287 15.8454 1.1149 15.5171 1.46949L6.14206 11.5945C5.97228 11.7778 5.73221 11.8799 5.48237 11.8748C5.23253 11.8698 4.99677 11.7582 4.83452 11.5681L0.459523 6.44311C0.145767 6.07557 0.18937 5.52327 0.556912 5.20951C0.924454 4.89575 1.47676 4.93936 1.79051 5.3069L5.52658 9.68343L14.233 0.280522C14.5613 -0.0740672 15.1149 -0.0953599 15.4695 0.232963Z" fill="white"/>`;
      return svg;
    }

    function createErrorIcon() {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "16");
      svg.setAttribute("height", "16");
      svg.setAttribute("viewBox", "0 0 16 16");
      svg.innerHTML = `<path fill-rule="evenodd" clip-rule="evenodd" d="M1.25628 1.25628C1.59799 0.914573 2.15201 0.914573 2.49372 1.25628L8 6.76256L13.5063 1.25628C13.848 0.914573 14.402 0.914573 14.7437 1.25628C15.0854 1.59799 15.0854 2.15201 14.7437 2.49372L9.23744 8L14.7437 13.5063C15.0854 13.848 15.0854 14.402 14.7437 14.7437C14.402 15.0854 13.848 15.0854 13.5063 14.7437L8 9.23744L2.49372 14.7437C2.15201 15.0854 1.59799 15.0854 1.25628 14.7437C0.914573 14.402 0.914573 13.848 1.25628 13.5063L6.76256 8L1.25628 2.49372C0.914573 2.15201 0.914573 1.59799 1.25628 1.25628Z" fill="white"/>`;
      return svg;
    }

    function createInfoIcon() {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "14");
      svg.setAttribute("height", "14");
      svg.setAttribute("viewBox", "0 0 14 14");
      svg.innerHTML = `<path fill-rule="evenodd" clip-rule="evenodd" d="M10 1.5H4C2.61929 1.5 1.5 2.61929 1.5 4V10C1.5 11.3807 2.61929 12.5 4 12.5H10C11.3807 12.5 12.5 11.3807 12.5 10V4C12.5 2.61929 11.3807 1.5 10 1.5ZM4 0C1.79086 0 0 1.79086 0 4V10C0 12.2091 1.79086 14 4 14H10C12.2091 14 14 12.2091 14 10V4C14 1.79086 12.2091 0 10 0H4Z" fill="white"/><path fill-rule="evenodd" clip-rule="evenodd" d="M5.25 7C5.25 6.58579 5.58579 6.25 6 6.25H7.25C7.66421 6.25 8 6.58579 8 7V10.5C8 10.9142 7.66421 11.25 7.25 11.25C6.83579 11.25 6.5 10.9142 6.5 10.5V7.75H6C5.58579 7.75 5.25 7.41421 5.25 7Z" fill="white"/><path d="M5.75 4C5.75 3.31075 6.31075 2.75 7 2.75C7.68925 2.75 8.25 3.31075 8.25 4C8.25 4.68925 7.68925 5.25 7 5.25C6.31075 5.25 5.75 4.68925 5.75 4Z" fill="white"/>`;
      return svg;
    }
  </script>
  <script src="../assets/js/calendar.js"></script>
  <script src="../js/nombres.js"></script>

</body>

</html>